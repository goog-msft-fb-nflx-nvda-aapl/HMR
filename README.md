```markdown
# Silhouette Generation with SAM and SSP-3D Integration

This repository provides a tool to generate accurate binary silhouettes for human subjects in images using the Segment Anything Model (SAM). The tool leverages keypoints and bounding boxes from the SSP-3D dataset as prompts to refine the silhouette predictions.

## Table of Contents
- [Overview](#overview)
- [Requirements](#requirements)
- [Usage](#usage)
  - [Arguments](#arguments)
- [Inputs](#inputs)
- [Outputs](#outputs)
- [Examples](#examples)
- [References](#references)

## Overview
### Problem
The binary silhouettes provided by SSP-3D are generated using models like PointRend or DensePose and often lack precision. This tool aims to replace these silhouettes with more accurate ones generated by SAM.

### Workflow
1. **Input Data**: Images, keypoints, and bounding boxes from the SSP-3D dataset.
2. **SAM Prediction**: Use SAM with keypoints and bounding boxes as prompts to predict precise binary silhouettes.
3. **Visualization**: Compare the original image, SSP-3D silhouette, and SAM-predicted silhouette side-by-side for verification.

## Requirements
- Python >= 3.8
- Dependencies:
  - `numpy`
  - `opencv-python`
  - `torch`
  - `segment-anything` (Install [here](https://github.com/facebookresearch/segment-anything))

Install dependencies using:
```bash
pip install -r requirements.txt
```

## Usage
### Running the Script
Execute the script with the required arguments:
```bash
python silhouette_generator.py --labels_path ./data/labels.npz \
                               --img_dir ./images \
                               --silh_dir ./ssp_silhouettes \
                               --out_dir ./silhouettes_SAM \
                               --visualization_dir ./visualization \
                               --sam_checkpoint ./sam_vit_h_4b8939.pth
```

### Arguments
| Argument              | Description                                                                                          | Default                 |
|-----------------------|------------------------------------------------------------------------------------------------------|-------------------------|
| `--labels_path`       | Path to the SSP-3D `.npz` file containing keypoints and metadata.                                    | **Required**            |
| `--img_dir`           | Directory containing input images referenced in `labels.npz`.                                       | `./images`              |
| `--silh_dir`          | Directory containing SSP-3D silhouettes for comparison.                                             | `./ssp_silhouettes`     |
| `--out_dir`           | Directory to save SAM-predicted silhouettes.                                                        | `./silhouettes_SAM`     |
| `--visualization_dir` | Directory to save visualization images comparing silhouettes.                                        | `./visualization`       |
| `--sam_checkpoint`    | Path to the SAM checkpoint file.                                                                    | `./sam_vit_h_4b8939.pth`|

## Inputs
1. **Labels File (`labels.npz`)**:
   - Contains metadata for processing. Keys include:
     - `fnames`: Image filenames.
     - `joints2D`: COCO keypoints with shape `(N, 17, 3)` where `(x, y, confidence)`.
     - `bbox_centres` and `bbox_whs`: Bounding box centers and dimensions.
2. **Images**: Input images referenced by `fnames`.
3. **SSP-3D Silhouettes**: Pre-generated binary silhouettes for comparison.

## Outputs
1. **SAM Silhouettes**:
   - Saved in the directory specified by `--out_dir`.
   - Each silhouette is a binary mask with the same name as the input image.
   
2. **Visualization**:
   - Comparison of the original image, SSP-3D silhouette, and SAM-predicted silhouette.
   - Saved in the directory specified by `--visualization_dir`.

## Outputs/Visualization
Below is an example of the visualization comparing the original image, SSP-3D silhouette, and SAM-predicted silhouette:

![Example Visualization](./example_visualization.png "Visualization Example")


## Examples
### Example Visualization
Below is an example of a visualization comparing the original image, SSP-3D silhouette, and SAM-predicted silhouette.

```
+-----------------+------------------------+----------------------+
| Original Image  | Silhouette by SSP-3D  | Silhouette by SAM    |
+-----------------+------------------------+----------------------+
```

### Error Handling
If an error occurs while processing an image (e.g., missing file), it will be logged, and the script will continue with the next image.

## References
1. [SSP-3D Dataset](https://github.com/akashsengupta1997/SSP-3D)  
2. [PointRend](https://github.com/facebookresearch/detectron2/tree/main/projects/PointRend)  
3. [DensePose](https://github.com/facebookresearch/detectron2/tree/main/projects/DensePose)  
4. [Segment Anything Model (SAM)](https://github.com/facebookresearch/segment-anything)  
5. [COCO Dataset](https://cocodataset.org/)  

For questions or issues, feel free to open an issue in this repository.
```